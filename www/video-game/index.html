<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>VTS</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="shortcut icon" href="assets/images/favicon.ico" />

    <script src="assets/js/scorm.js"></script>
    <script src="assets/js/xhook-min.js"></script>
    <script type="text/javascript">

      if (document.domain.indexOf("localhost") === -1) {
        document.domain="openbusinesslabs.com";
      }

      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      const gameId = getParameterByName("game_id");
      const scenarioId = getParameterByName("scenario_id");
      var mediaUrl = "";
      if (getParameterByName("default")) {
        mediaUrl = "/video-game/default";
      } else if (getParameterByName("local")) {
        mediaUrl = "http://localhost:3002/shared/video-game/game-" + gameId + "/scenario-" + scenarioId;
      } else {
        mediaUrl = "https://media.openbusinesslabs.com/video-game/game-" + gameId + "/scenario-" + scenarioId;
      }

      console.log("LOADING GAME FROM : " + mediaUrl)
      function loadXHook() {
        xhook.before(function(request) {
          if (request.url.match(/StreamingAssets.*/)) {
            var url = request.url
            if (request.url.match(/http.*/))Â {
              var splitted = request.url.split("StreamingAssets")
              url = "StreamingAssets" + splitted[1]
            }

            url = mediaUrl + "/" + url;
            request.url = url;
          }
        });
      }

      hasLoad = false;
      function getScreenSize(objectname,callbackname) {
        var width = canvas.clientWidth;
        var height = canvas.clientHeight;
        SendMessage(objectname,callbackname, width + "|" + height);
      }

      function resize_canvas(idobj){
        canvas = document.getElementById('canvas');
        loading = document.getElementById("iloading");
        logo = document.getElementById("lloading");
        bg = document.getElementById("bgloading");
        logo.style.top = 50 + '%';
        logo.style.left = 50 + '%';
        logo.style.position = 'absolute';
        logo.style.marginLeft = -237 + 'px';

        bg.style.top = 50 + '%';
        bg.style.left = 50 + '%';
        bg.style.position = 'absolute';
        bg.style.marginLeft = -237 + 'px';
        if (window.innerHeight * 1.77 > window.innerWidth)
        {
          canvas.width = (window.innerWidth * 100)/100;
          canvas.height = (canvas.width * (9.0/16.0));
          loading.width = canvas.width;
          loading.height = canvas.height;
        }
        else
        {
          canvas.height = (window.innerHeight * 100)/100;
          canvas.width = (canvas.height * (16.0/9.0));
          loading.width = canvas.width;
          loading.height = canvas.height;				
        }
        ratio = loading.width / 1920;
        logo.style.marginTop = -logo.height * ratio  + 'px';

        loading.style.top = ((window.innerHeight / 2) - loading.height * 0.5) + 'px';
        loading.style.left = ((window.innerWidth / 2) - loading.width * 0.5) + 'px';
        loading.style.position = 'absolute';
        //ratio = 1;
        bg.style.transformOrigin = '50% 0%';
        logo.style.transformOrigin = '50% 0%';

        logo.style.transform = "scale(" + ratio+ ")";
        bg.style.transform = "scale(" + ratio+ ")";
        var bodyRect = document.body.getBoundingClientRect(),
        elemRect = logo.getBoundingClientRect();

        offset  = elemRect.bottom - bodyRect.top + logo.style.height* ratio;

        bg.style.top = offset + 'px';
      }

      function StartPlayer() {
        hasLoad = true;
        setTimeout(function () {
          document.getElementById("loading").style.display = "none";
          document.getElementById("canvas").style.display = "block";
        }, 1000);
      }

      function RandMinmax(min, max) {
        return Math.random() * (max - min) + min;
      }

      function loadingPlayer()
      {
        if (!hasLoad)
          document.getElementById("loading").style.visibility = 'visible';
        curIndex = 0;
        for (t=0;t <= 4; ++t)
        {
          curI = document.getElementById("a0" + t);
          if (curI.style.display != 'none')
          {
            curIndex = t;
            continue;
          }
          break;
        }

        up = RandMinmax(0,100) > 50;
        if (up && curIndex < 4)
        {
          document.getElementById("a0" + (curIndex)).style.display = 'inline-block';
          document.getElementById("a0" + (curIndex + 1)).style.display = 'inline-block';
        }
        else
        {
          document.getElementById("a0"+ (curIndex)).style.display = 'none';
        }
        setTimeout(function() { loadingPlayer()}, RandMinmax(30,80));
      }
    </script>
  </head>

  <body class="template" onload="loadXHook();resize_canvas();loadingPlayer()" onresize="resize_canvas()" style="overflow:hidden">
    <div align="center" id="loading" style="visibility:hidden">
      <img src="assets/images/Splash.png" id="iloading" alt="loading" title="loading" />
      <img src="assets/images/Logo.png" id="lloading" alt="logo" title="logo" width="471px;" />
      <div id="bgloading" style="background-image:url(assets/images/Dash.png);width:474px;height:78px;padding-top:23px;" >
        <img src="assets/images/Loading.png" id="io" style="margin-left:-228px;margin-top:-18px;position:absolute;"/>
        <img src="assets/images/LightOn.png" id="a00" style="margin-left:-147px;position:absolute;"/>
        <img src="assets/images/LightOn.png" id="a01" style="margin-left:-73px;position:absolute;" />
        <img src="assets/images/LightOn.png" id="a02" style="margin-left:0px;;position:absolute;"  />
        <img src="assets/images/LightOn.png" id="a03" style="margin-left:73px;position:absolute;"  />
        <img src="assets/images/LightOn.png" id="a04" style="margin-left:146px;position:absolute;"  />


        <img src="assets/images/LightOn.png" id="a10" style="margin-top:30px;margin-left:-147px;position:absolute;"/>
        <img src="assets/images/LightOn.png" id="a11" style="margin-top:30px;margin-left:-73px;position:absolute;" />
        <img src="assets/images/LightOn.png" id="a12" style="margin-top:30px;margin-left:0px;;position:absolute;"  />
        <img src="assets/images/LightOn.png" id="a13" style="margin-top:30px;margin-left:73px;position:absolute;"  />
        <img src="assets/images/LightOn.png" id="a14" style="margin-top:30px;margin-left:146px;position:absolute;"  />
      </div>
    </div>
    <div class="template-wrap clear">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" width="960" height="640" style="display:none"></canvas>
    </div>
    <p class="footer"></p>
    <script type='text/javascript'>
      var Module = {
        TOTAL_MEMORY: 268435456,
        errorhandler: function(err, url, line) {
          console.log("ERROR : ")
          console.log(err)
        },			// arguments: err, url, line. This function must return 'true' if the error is handled, otherwise 'false'
        compatibilitycheck: null,
        dataUrl: mediaUrl + "/Release/WebPlayer.data",
        codeUrl: mediaUrl + "/Release/WebPlayer.js",
        memUrl: mediaUrl + "/Release/WebPlayer.mem",
        asmUrl: mediaUrl + "/Release/WebPlayer.asm.js"
      };
      console.log("Allocated memory : " + Module.TOTAL_MEMORY)
    </script>
    <script src="assets/js/UnityLoader.js"></script>

  </body>
</html>
